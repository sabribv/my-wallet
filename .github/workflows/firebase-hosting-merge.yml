# This file was auto-generated by the Firebase CLI
# https://github.com/firebase/firebase-tools

name: Deploy to Firebase Hosting on merge
on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout del repositorio
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. Configurar Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      # 3. Instalar dependencias
      - name: Install dependencies
        run: npm install

      # 4. Crear archivo de configuraci칩n din치mico (firebase-config.ts)
      - name: Generate firebase-config.ts
        run: |
          echo "export const firebaseConfig = {
            apiKey: '${{ secrets.FIREBASE_API_KEY }}',
            authDomain: '${{ secrets.FIREBASE_AUTH_DOMAIN }}',
            projectId: '${{ secrets.FIREBASE_PROJECT_ID }}',
            storageBucket: '${{ secrets.FIREBASE_STORAGE_BUCKET }}',
            messagingSenderId: '${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}',
            appId: '${{ secrets.FIREBASE_APP_ID }}',
            measurementId: '${{ secrets.FIREBASE_MEASUREMENT_ID }}',
            vapidKey: '${{ secrets.FIREBASE_VAPID_KEY}}',
          };" > src/app/firebase-config.ts

      # 5. Construir el proyecto
      - name: Build project
        run: npm run build # Cambia el script si usas algo diferente a npm

      # 6. Crear archivo de configuraci칩n din치mico para el Service Worker (firebase-messaging-sw.js)
      - name: Generate firebase-messaging-sw.js
        run: |
          echo "importScripts('https://www.gstatic.com/firebasejs/10.13.2/firebase-app-compat.js');
            importScripts('https://www.gstatic.com/firebasejs/10.13.2/firebase-messaging-compat.js');

            const firebaseConfig = {
            apiKey: '${{ secrets.FIREBASE_API_KEY }}',
            authDomain: '${{ secrets.FIREBASE_AUTH_DOMAIN }}',
            projectId: '${{ secrets.FIREBASE_PROJECT_ID }}',
            storageBucket: '${{ secrets.FIREBASE_STORAGE_BUCKET }}',
            messagingSenderId: '${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}',
            appId: '${{ secrets.FIREBASE_APP_ID }}',
            measurementId: '${{ secrets.FIREBASE_MEASUREMENT_ID }}',
            vapidKey: '${{ secrets.FIREBASE_VAPID_KEY}}',
          };

            firebase.initializeApp(firebaseConfig);
            const messaging = firebase.messaging();

            messaging.onMessage((payload) => {
            console.log('Message received. ', payload);
          });

            messaging.onBackgroundMessage((payload) => {
            console.log(
            '[firebase-messaging-sw.js] Received background message ',
            payload
            );
          });" > dist/firebase-messaging-sw.js

      # 7. Deploy a Firebase Hosting
      - name: Deploy to Firebase Hosting
        uses: firebase/actions/hosting-deploy@v0
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_MY_WALLET_4C02F }}'
          channelId: live
          projectId: '${{ secrets.FIREBASE_PROJECT_ID }}'
